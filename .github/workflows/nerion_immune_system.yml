name: Nerion Immune System üõ°Ô∏è

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'  # Run every night at 2 AM UTC

permissions:
  contents: write
  pull-requests: write

jobs:
  # ------------------------------------------------------------------
  # 1. REACTIVE DEFENSE (Run on every Push)
  # ------------------------------------------------------------------
  defense:
    name: üõ°Ô∏è Reactive Defense
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install anthropic pytest
          
      - name: Run Tests
        id: run_tests
        run: |
          pytest || echo "Tests Failed"
          
      - name: Auto-Fix (If Tests Failed)
        if: failure() || steps.run_tests.outcome == 'failure'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üö® Tests failed! Deploying Universal Fixer..."
          # Find failed tests (simplified logic, ideally fixer parses pytest output directly)
          # For now, we run fixer on the whole test directory or specific files
          # The fixer needs a target. Let's assume we run it on the tests folder.
          python nerion_digital_physicist/universal_fixer.py tests/ --mode fix
          
      - name: Verify Fix
        if: failure() || steps.run_tests.outcome == 'failure'
        run: |
          pytest
          
      - name: Commit Fix
        if: success() && (failure() || steps.run_tests.outcome == 'failure') # Only if tests originally failed but now pass
        run: |
          git config --global user.name 'Nerion Immune System'
          git config --global user.email 'immune-system@nerion.ai'
          git add .
          git commit -m "üõ°Ô∏è Auto-fixed test failures"
          git push

  # ------------------------------------------------------------------
  # 2. PROACTIVE EVOLUTION (Run Nightly)
  # ------------------------------------------------------------------
  evolution:
    name: üß¨ Proactive Evolution
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install anthropic pytest mypy
          
      - name: Evolve Quality (Refactoring)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Pick a random python file to evolve (excluding tests and hidden files)
          TARGET=$(find . -name "*.py" -not -path "*/tests/*" -not -path "*/.*" | shuf -n 1)
          echo "üß¨ Evolving Quality for: $TARGET"
          python nerion_digital_physicist/universal_fixer.py "$TARGET" --mode evolve_quality
          
      - name: Evolve Types (Type Safety)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Pick another random file
          TARGET=$(find . -name "*.py" -not -path "*/tests/*" -not -path "*/.*" | shuf -n 1)
          echo "üß¨ Evolving Types for: $TARGET"
          python nerion_digital_physicist/universal_fixer.py "$TARGET" --mode evolve_types

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "üß¨ Proactive Evolution: Quality & Types"
          title: "üß¨ Nerion Immune System: Nightly Evolution"
          body: |
            The Nerion Immune System has proactively improved the codebase.
            
            **Changes:**
            - Refactored code for quality (SOLID, Clean Code).
            - Added missing type hints.
            
            *Generated automatically by Universal Fixer.*
          branch: immune-system-evolution
          delete-branch: true
